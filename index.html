<!DOCTYPE html>
<html>
	<!-- stomp, a simple whack-a-game
    Copyright (C) 2015 Nick Stanchenko (http://github.com/stanch)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>-->
	<head>
		<meta charset="UTF-8"/>
		<title>stomp</title>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/>
		<link rel="shortcut icon" type="image/png" href="icon.png"/>
		<link rel="shortcut icon" sizes="128x128" href="icon.png"/>
		<link rel="apple-touch-icon" href="icon.png"/>
		<style type="text/css">
			html, body {
				margin: 0;
				padding: 0;
				height: 100%;
			}
			body, button {
				font-family: sans-serif;
				font-weight: 600;
			}
			i {
				margin: 5px;
				margin-bottom: 0;
			}
			.fa {
				line-height: 0.9em;
			}
			.popup {
				font-size: 3em;
				line-height: 1.1em;
				text-align: center;
				font-style: italic;
				visibility: hidden;
				width: 100%;
				height: 100%;
				box-sizing: border-box;
				padding: 0 0.5em;
				display: -webkit-flex;
				display: flex;
				-webkit-flex-direction: column;
				flex-direction: column;
				-webkit-justify-content: center;
				justify-content: center;
				-webkit-align-items: center;
				align-items: center;
				position: absolute;
				color: #EDEDED;
				background-color: #1485CC;
			}
			.popup button {
				font-size: 1em;
				line-height: 1.1em;
				font-weight: 700;
				border: none;
				border-radius: 10px;
				margin-top: 0.8em;
				padding: 0.1em 0.8em;
				color: #0A7BC2;
				background-color: #FFFC19;
				box-shadow: 0 0 10px 5px #0A7BC2;
				cursor: pointer;
			}
			.popup .social {
				margin-top: 0.8em;
			}
			.popup .social .button {
				display: -webkit-inline-flex;
				display: inline-flex;
				-webkit-flex-direction: column;
				flex-direction: column;
			}
			.popup .social .button span {
				font-size: 8pt;
				line-height: 8pt;
				font-weight: 700;
				font-variant: small-caps;
			}
			.popup .social .button a {
				color: #EDEDED;
				text-decoration: none;
				margin: 0 0.2em;
				text-shadow: 0 0 5px #0A7BC2;
			}
			.game {
				width: 100%;
				height: 100%;
				display: -webkit-flex;
				display: flex;
				-webkit-flex-direction: column;
				flex-direction: column;
			}
			.meters {
				display: -webkit-flex;
				display: flex;
				-webkit-flex-direction: row;
				flex-direction: row;
				-webkit-justify-content: space-between;
				justify-content: space-between;
				font-size: 2em;
				padding: 2px 0;
				color: #EDEDED;
				background-color: #0A7BC2;
				border-bottom: 1px solid #0971B2;
			}
			.grid {
				display: -webkit-flex;
				display: flex;
				-webkit-flex-grow: 1;
				flex-grow: 1;
				-webkit-flex-direction: column;
				flex-direction: column;
			}
			.row {
				display: -webkit-flex;
				display: flex;
				-webkit-flex-grow: 1;
				flex-grow: 1;
				-webkit-flex-direction: row;
				flex-direction: row;
			}
			.cell {
				flex-grow: 1;
				-webkit-flex-grow: 1;
				border: 1px solid #0971B2;
				background-color: #1485CC;
				-webkit-transition: all 0.1s;
				transition: all 0.1s;
			}
			.cell.target {
				background-color: #FFFC19;
			}
			.target-color {
				color: #FFFC19;
			}
			.cell.distractor {
				background-color: orange;
			}
			.cell.touched {
				background-color: #F06565;
				-webkit-transition: all 0s;
				transition: all 0s;
			}
			.cell.target.touched {
				background-color: #16A216;
			}
		</style>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<script type="text/javascript">
			"use strict";
			$.fn.random = function() {
				const index = Math.floor(Math.random() * this.length);
				return $(this[index]);
			};
			let score = 0;
			let start = undefined;
			let latencies = [];
			let average = undefined;
			let targets = 1;
			let distractors = 0;
			function reset() {
				score = 0;
				latencies = [];
				average = undefined;
				targets = 1;
				distractors = 0;
				draw();
				countdown();
				resume();
			}
			function advance() {
				const correct = $('.cell.target:not(.touched)').length==0 && $('.cell.touched:not(.target)').length==0;
				$('.cell').removeClass('touched');
				if (!correct) {
					penalize();
				} else {
					reward();
					estimate();
					complicate();
					draw();
					start = new Date().getTime();
				}
			}
			function estimate() {
				latencies.push(new Date().getTime() - start);
				if (latencies.length > 5) latencies.shift();
				average = latencies.reduce((a, b) => a + b) / latencies.length;
			}
			function reward() {
				score += 100 * Math.pow(5, Math.floor(targets) - 1) + Math.floor(distractors) * 10;
				$('.score').text(score);
			}
			function penalize() {
				score = Math.max(score - 10, 0);
				$('.score').text(score);
			}
			function complicate() {
				if (average < 650) {
					targets = Math.min(targets + 0.3, 4);
					distractors = Math.min(distractors + 1, 7);
				} else if (average > 700) {
					targets = Math.max(targets - 0.3, 1);
					distractors = Math.max(distractors - 1, 0);
				}
			}
			function popup(id, repeat) {
				if (repeat || !window.localStorage[id]) {
					$('#' + id).css('visibility', 'visible');
					window.localStorage[id] = true;
				}
			}
			function resume() {
				$('.popup').css('visibility', 'hidden');
				start = new Date().getTime();
			}
			function draw() {
				$('.cell.target').addClass('oldtarget');
				clear();
				for (let i=0; i<Math.floor(targets); i++) {
					$('.cell:not(.target):not(.oldtarget)').random().addClass('target');
				}
				$('.cell.oldtarget').removeClass('oldtarget');
				for (let i=0; i<Math.floor(distractors); i++) {
					$('.cell:not(.target):not(.distractor)').random().addClass('distractor');
				}
			}
			function clear() {
				$('.cell').removeClass('target distractor touched');
			}
			function bind() {
				let touchTimer = undefined;
				$('.grid').on('touchstart', event => {
					event.preventDefault();
					if (!touchTimer) touchTimer = window.setTimeout(() => {
						touchTimer = undefined;
						advance();
					}, 50);
					for (let i=0; i<event.originalEvent.touches.length; i++) {
						$(event.originalEvent.touches[i].target).addClass('touched');
					}
				});
				$(document).on('touchmove', event => event.preventDefault());
			}
			function countdown() {
				const time = 60;
				$('#time').text(time);
				$('.score').text(score);
				$('#hourglass').removeClass('fa-hourglass-start fa-hourglass-half fa-hourglass-end').addClass('fa-hourglass-start');
				const gameEnd = new Date().getTime() + time * 1000;
				const gameTimer = window.setInterval(() => {
					const left = Math.floor((gameEnd - new Date().getTime()) / 1000);
					$('#time').text(left);
					const gl = left > time*2/3 ? 'start' : left > time/3 ? 'half' : 'end';
					$('#hourglass').removeClass('fa-hourglass-start fa-hourglass-half fa-hourglass-end').addClass('fa-hourglass-' + gl);
					if (left <= 0) {
						window.clearTimeout(gameTimer);
						clear();
						popup('over', true);
					}
				}, 1000);
			}
			function forceTouch() {
				window.localStorage['forceTouch'] = true;
				location.reload();
			}
			$(function() {
				if (window.localStorage['forceTouch'] || 'ontouchstart' in window || navigator.maxTouchPoints) {
					bind();
					reset();
				} else {
					popup('notouch', true);
				}
			})
		</script>
		<script type="text/javascript">
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-71790720-1', 'auto');
			ga('send', 'pageview');
		</script>
	</head>
	<body>
		<div id="notouch" class="popup">
			<span>This game only works with multi-touch,<br/>but it looks like you don’t have a touchscreen <i class="fa fa-frown-o"></i></span>
			<button onclick="forceTouch()">Lies, I do!</button>
		</div>
		<div id="over" class="popup">
			<span>Time’s up!<br/>You scored <span class="score target-color"></span>&nbsp;points.</span>
			<div class="social">
				<span class="button">
					<a href="https://twitter.com/intent/tweet?text=Check out stomp!&amp;url=http://stanch.github.io/stomp/&amp;via=@nickstanch">
						<i class="fa fa-twitter"></i>
					</a>
					<span>share on<br/>twitter</span>
				</span>
				<span class="button">
					<a href="bitcoin:1FwpNShXy3weNcyH1TEfFKb6JBPn8v9t6t">
						<i class="fa fa-btc"></i>
					</a>
					<span>send me<br/>bitcoin</span>
				</span>
				<span class="button">
					<a href="http://github.com/stanch/stomp">
						<i class="fa fa-github"></i>
					</a>
					<span>report<br/>an issue</span>
				</span>
			</div>
			<button onclick="reset()">Play again!</button>
		</div>
		<div class="game">
			<div class="meters">
				<div>
					<i id="hourglass" class="fa fa-hourglass-start"></i><span id="time"></span>
				</div>
				<div>
					<span class="score"></span><i class="fa fa-trophy"></i>
				</div>
			</div>
			<div class="grid">
				<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
				<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
				<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
				<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
			</div>
		</div>
	</body>
</html>

