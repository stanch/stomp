<!DOCTYPE html>
<html>
	<!-- stomp, a simple whack-a-game
    Copyright (C) 2015 Nick Stanchenko (http://github.com/stanch)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>-->
	<head>
		<meta charset="UTF-8"/>
		<title>stomp</title>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/>
		<link rel="stylesheet" type="text/css" href='https://fonts.googleapis.com/css?family=Fira+Sans:400,400italic'/>
		<link rel="shortcut icon" type="image/png" href="icon.png"/>
		<link rel="shortcut icon" sizes="128x128" href="icon.png"/>
		<link rel="apple-touch-icon" href="icon.png"/>
		<style type="text/css">
			html, body {
				margin: 0;
				padding: 0;
				height: 100%;
			}
			body, button {
				font-family: 'Fira Sans', sans-serif;
			}
			i {
				margin: 5px;
				margin-bottom: 0;
			}
			.popup {
				font-size: 3em;
				line-height: 1.1em;
				text-align: center;
				font-style: italic;
				visibility: hidden;
				width: 100%;
				height: 100%;
				box-sizing: border-box;
				padding: 0 0.5em;
				display: -webkit-flex;
				display: flex;
				-webkit-flex-direction: column;
				flex-direction: column;
				-webkit-justify-content: center;
				justify-content: center;
				-webkit-align-items: center;
				align-items: center;
				position: absolute;
				color: #EDEDED;
				background-color: #1485CC;
			}
			.popup button {
				font-size: 1em;
				line-height: 1.1em;
				border: none;
				border-radius: 10px;
				margin-top: 0.8em;
				padding: 0.1em 0.8em;
				color: #0A7BC2;
				background-color: #FFFC19;
			}
			.popup .social {
				margin-top: 0.8em;
			}
			.popup .social .button {
				display: -webkit-inline-flex;
				display: inline-flex;
				-webkit-flex-direction: column;
				flex-direction: column;
			}
			.popup .social .button span {
				font-size: 8pt;
				line-height: 8pt;
				font-variant: small-caps;
			}
			.popup .social .button a {
				color: #EDEDED;
				text-decoration: none;
				margin: 0 0.2em;
			}
			.meters {
				display: -webkit-flex;
				display: flex;
				-webkit-flex-direction: row;
				flex-direction: row;
				-webkit-justify-content: space-between;
				justify-content: space-between;
				font-size: 2em;
				color: #EDEDED;
				background-color: #0A7BC2;
				border-bottom: 1px solid #0971B2;
			}
			.grid {
				width: 100%;
				height: 100%;
				display: -webkit-flex;
				display: flex;
				-webkit-flex-direction: column;
				flex-direction: column;
			}
			.row {
				display: -webkit-flex;
				display: flex;
				-webkit-flex-grow: 1;
				flex-grow: 1;
				-webkit-flex-direction: row;
				flex-direction: row;
			}
			.cell {
				flex-grow: 1;
				-webkit-flex-grow: 1;
				border: 1px solid #0971B2;
				background-color: #1485CC;
				-webkit-transition: all 0.2s;
				-moz-transition: all 0.2s;
				-ms-transition: all 0.2s;
				-o-transition: all 0.2s;
				transition: all 0.2s;
			}
			.cell.target {
				background-color: #FFFC19;
			}
			.target-color {
				color: #FFFC19;
			}
			.cell.distractor {
				background-color: orange;
			}
			.cell.touched {
				background-color: #F06565;
				-webkit-transition: all 0s;
				-moz-transition: all 0s;
				-ms-transition: all 0s;
				-o-transition: all 0s;
				transition: all 0s;
			}
			.cell.target.touched {
				background-color: #16A216;
			}
		</style>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<script type="text/javascript">
			$.fn.random = function() {
				var index = Math.floor(Math.random() * this.length);
				return $(this[index]);
			};
			var score = 0;
			var start = undefined;
			var latencies = [];
			var average = undefined;
			var targets = 1;
			var distractors = 0;
			function reset() {
				score = 0;
				latencies = [];
				average = undefined;
				targets = 1;
				distractors = 0;
				draw();
				countdown();
				resume();
			}
			function next(correct) {
				if (correct) reward();
				else penalize();
				estimate(correct);
				complicate();
				draw();
				if (correct) start = new Date().getTime();
			}
			function estimate() {
				latencies.push(new Date().getTime() - start);
				if (latencies.length > 5) latencies.shift();
				average = latencies.reduce(function(a, b) { return a + b }) / latencies.length;
			}
			function reward() {
				score += 100 * Math.pow(5, Math.floor(targets) - 1) + Math.floor(distractors) * 10;
				$('.score').text(score);
			}
			function penalize() {
				pause('miss');
				score = Math.max(score - 1000, 0);
				$('.score').text(score);
			}
			function complicate() {
				if (average < 650) {
					targets = Math.min(targets + 0.3, 4);
					if (targets >= 2) pause('double');
					else pause('levelup');
					distractors = Math.min(distractors + 1, 7);
				} else if (average > 700) {
					targets = Math.max(targets - 0.3, 1);
					distractors = Math.max(distractors - 1, 0);
				}
			}
			function pause(popup) {
				if (!window.localStorage[popup]) {
					$('#' + popup).css('visibility', 'visible');
					if (popup != 'over') window.localStorage[popup] = true;
				}
			}
			function resume() {
				$('.popup').css('visibility', 'hidden');
				start = new Date().getTime();
			}
			function draw() {
				$('.cell.target').addClass('oldtarget');
				clear();
				for (var i=0; i<Math.floor(targets); i++) {
					$('.cell:not(.target):not(.oldtarget)').random().addClass('target');
				}
				$('.cell.oldtarget').removeClass('oldtarget');
				for (var i=0; i<Math.floor(distractors); i++) {
					$('.cell:not(.target):not(.distractor)').random().addClass('distractor');
				}
			}
			function clear() {
				$('.cell').removeClass('target distractor touched');
			}
			function bind() {
				var touchTimer = undefined;
				$('.grid').on('touchstart', function(event) {
					event.preventDefault();
					if (!touchTimer) touchTimer = window.setTimeout(function() {
						touchTimer = undefined;
						next($('.cell.target:not(.touched)').length==0 && $('.cell.touched:not(.target)').length==0);
					}, 50);
					for (var i=0; i<event.originalEvent.touches.length; i++) {
						$(event.originalEvent.touches[i].target).addClass('touched');
					}
				});
				$(document).on('touchmove', function(event) {
					event.preventDefault();
				});
			}
			function countdown() {
				var time = 60;
				$('#time').text(time);
				$('.score').text(0);
				$('#hourglass').removeClass('fa-hourglass-start fa-hourglass-half fa-hourglass-end').addClass('fa-hourglass-start');
				var gameEnd = new Date().getTime() + time * 1000;
				var gameTimer = window.setInterval(function() {
					var left = Math.floor((gameEnd - new Date().getTime()) / 1000);
					$('#time').text(left);
					var gl = left > time*2/3 ? 'start' : left > time/3 ? 'half' : 'end';
					$('#hourglass').removeClass('fa-hourglass-start fa-hourglass-half fa-hourglass-end').addClass('fa-hourglass-' + gl);
					if (left <= 0) {
						window.clearTimeout(gameTimer);
						clear();
						pause('over');
					}
				}, 1000);
			}
			$(function() {
				bind();
				reset();
				pause('init');
				setTimeout(function() { pause('levelup') }, 10000);
			})
		</script>
		<script type="text/javascript">
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-71790720-1', 'auto');
			ga('send', 'pageview');
		</script>
	</head>
	<body>
		<div id="init" class="popup">
			<span>Tap once on each <span class="target-color">yellow</span> cell.</span>
			<button onclick="resume()">Got it!</button>
		</div>
		<div id="miss" class="popup">
			<span>When you miss, you lose points and momentum.</span>
			<button onclick="resume()">Woah, OK!</button>
		</div>
		<div id="levelup" class="popup">
			<span>The quicker you become, the harder it gets, the more points.</span>
			<button onclick="resume()">Awesome!</button>
		</div>
		<div id="double" class="popup">
			<span>Don’t forget, all <span class="target-color">yellow</span> cells have to be tapped simultaneously.</span>
			<button onclick="resume()">Argh, just<br/>let me<br/>play!</button>
		</div>
		<div id="over" class="popup">
			<span>Time’s up!<br/>You scored <span class="score target-color"></span>&nbsp;points.</span>
			<div class="social">
				<span class="button">
					<a href="https://twitter.com/intent/tweet?text=Check out stomp!&amp;url=http://stanch.github.io/stomp/&amp;via=@nickstanch">
						<i class="fa fa-twitter"></i>
					</a>
					<span>share on<br/>twitter</span>
				</span>
				<span class="button">
					<a href="bitcoin:1FwpNShXy3weNcyH1TEfFKb6JBPn8v9t6t">
						<i class="fa fa-btc"></i>
					</a>
					<span>send me<br/>bitcoin</span>
				</span>
				<span class="button">
					<a href="http://github.com/stanch/stomp">
						<i class="fa fa-github"></i>
					</a>
					<span>report<br/>an issue</span>
				</span>
			</div>
			<button onclick="reset()">Play again!</button>
		</div>
		<div class="grid">
			<div class="meters">
				<div>
					<i id="hourglass" class="fa fa-hourglass-start"></i><span id="time"></span>
				</div>
				<div>
					<span class="score"></span><i class="fa fa-trophy"></i>
				</div>
			</div>
			<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
			<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
			<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
			<div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
		</div>
	</body>
</html>

